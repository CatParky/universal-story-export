<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat MHTML to JSON Converter</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            opacity: 0.9;
        }

        .content {
            padding: 2rem;
        }

        .upload-section {
            text-align: center;
            padding: 3rem 2rem;
            border: 3px dashed #cbd5e0;
            border-radius: 12px;
            background: #f7fafc;
            transition: all 0.3s;
        }

        .upload-section.dragover {
            background: #edf2f7;
            border-color: #667eea;
        }

        .upload-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .upload-section h3 {
            color: #2d3748;
            margin-bottom: 0.5rem;
        }

        input[type="file"] {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: scale(1.05);
        }

        .options-section {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid #cbd5e0;
            text-align: left;
        }

        .options-section label {
            display: block;
            color: #4a5568;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
            font-weight: 500;
        }

        .options-section input[type="text"] {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
        }

        .checkbox-option {
            margin-top: 0.75rem;
        }

        .checkbox-option label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            font-weight: normal;
        }

        .checkbox-option input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }

        .instructions {
            margin-top: 2rem;
            padding: 1.5rem;
            background: #f7fafc;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .instructions h3 {
            color: #2d3748;
            margin-bottom: 1rem;
        }

        .instructions ol {
            margin-left: 1.5rem;
            color: #4a5568;
            line-height: 1.8;
        }

        .instructions li {
            margin-bottom: 0.5rem;
        }

        .instructions a {
            color: #667eea;
            text-decoration: none;
        }

        .instructions a:hover {
            text-decoration: underline;
        }

        .help-text {
            font-size: 0.8rem;
            color: #718096;
            margin-top: 0.25rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="text-align: left; margin-bottom: 1rem;">
                <a href="landing.html" style="color: white; text-decoration: none; opacity: 0.9; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 0.5rem;">
                    ‚Üê Back to The Refuge
                </a>
            </div>
            <h1>üíú Chat MHTML to JSON Converter</h1>
            <p>Convert saved chat exports for use with Story Extractor</p>
            <p style="font-size: 0.85rem; margin-top: 0.5rem; opacity: 0.8;">Version 1.4 ‚Ä¢ 23 February 2026</p>
        </div>

        <div class="content">
            <div class="upload-section" id="uploadSection">
                <div class="upload-icon">üìÅ</div>
                <h3>Drop your chat MHTML file here</h3>
                <p style="margin: 1rem 0; color: #718096;">or</p>
                <button class="btn" onclick="document.getElementById('fileInput').click()">Choose File</button>
                <input type="file" id="fileInput" accept=".mhtml,.mht">
                
                <div class="options-section">
                    <label>Assistant Character Name (e.g., Castiel, Gale)</label>
                    <input type="text" id="assistantName" placeholder="Leave blank to auto-detect">
                    <p class="help-text">If provided, messages will be identified as Assistant when the speaker contains this name</p>
                    
                    <label style="margin-top: 0.5rem;">User Character Name (e.g., Riv, River)</label>
                    <input type="text" id="userName" placeholder="Leave blank to auto-detect">
                    <p class="help-text">If provided, messages will be identified as User when the speaker contains this name</p>
                    
                    <div class="checkbox-option">
                        <label>
                            <input type="checkbox" id="swapOrder">
                            <span>Swap message order (Assistant first, then User)</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="instructions">
                <h3>üìã How to Use</h3>
                <ol>
                    <li>Save your chat page as MHTML (File ‚Üí Save Page As ‚Üí Webpage, Single File)</li>
                    <li><strong>Optional:</strong> Enter character names to help identify speakers (otherwise auto-detect)</li>
                    <li>Check "Swap message order" if your chat has the assistant speaking first</li>
                    <li>Drop the .mhtml file above or click "Choose File"</li>
                    <li>The converted JSON will download automatically</li>
                    <li>Upload the JSON to <a href="https://catparky.github.io/universal-story-export/index.html" target="_blank">Story Extractor</a></li>
                </ol>
            </div>
        </div>
    </div>

    <script>
        const uploadSection = document.getElementById('uploadSection');
        const fileInput = document.getElementById('fileInput');

        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                processFile(e.target.files[0]);
            }
        });

        function decodeQuotedPrintable(text) {
            text = text.replace(/=\r?\n\s*/g, '');
            text = text.replace(/=([0-9A-F]{2})/gi, (match, hex) => {
                return String.fromCharCode(parseInt(hex, 16));
            });
            return text;
        }

        function decodeHTML(text) {
            const textarea = document.createElement('textarea');
            textarea.innerHTML = text;
            return textarea.value;
        }

        function cleanTitle(title) {
            // Remove ALL non-ASCII characters (catches malformed emojis)
            title = title.replace(/[^\x20-\x7E]/g, '');
            // Remove brackets and their content  
            title = title.replace(/\s*\[.*?\]\s*/g, '');
            // Clean up extra spaces
            title = title.trim().replace(/\s+/g, ' ');
            return title;
        }

        function processFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    let content = e.target.result;
                    console.log('File loaded, size:', content.length);
                    
                    const assistantName = document.getElementById('assistantName').value.trim();
                    const userName = document.getElementById('userName').value.trim();
                    console.log('Assistant name:', assistantName || '(auto-detect)');
                    console.log('User name:', userName || '(auto-detect)');
                    
                    // Extract title
                    let title = 'Conversation';
                    const subjectMatch = content.match(/Subject:\s*(.+?)(?:\r?\n(?!\s))/s);
                    if (subjectMatch) {
                        let rawSubject = subjectMatch[1];
                        rawSubject = rawSubject.replace(/=\?[^?]+\?[QB]\?([^?]+)\?=/gi, (match, encoded) => {
                            encoded = encoded.replace(/=\r?\n\s*/g, '');
                            return decodeQuotedPrintable(encoded);
                        });
                        rawSubject = rawSubject.replace(/\r?\n\s*/g, '');
                        title = rawSubject
                            .replace(/\s*\|\s*\d+\s*memories.*$/i, '')
                            .replace(/\s*\|\s*\d+\s*interactions.*$/i, '')
                            .trim();
                        title = cleanTitle(title);
                    }
                    console.log('Title:', title);
                    
                    // Find HTML and decode
                    const htmlStartIndex = content.indexOf('<!DOCTYPE html>');
                    if (htmlStartIndex === -1) {
                        alert('Error: Could not find HTML content in MHTML file');
                        return;
                    }
                    console.log('Found HTML at index:', htmlStartIndex);
                    
                    content = content.substring(htmlStartIndex);
                    content = decodeQuotedPrintable(content);
                    console.log('Decoded content length:', content.length);
                    
                    // Find all speaker positions
                    const speakerPattern = /<span>([^<]+)<\/span>/g;
                    const speakerPositions = [];
                    let match;
                    
                    while ((match = speakerPattern.exec(content)) !== null) {
                        const speaker = match[1].trim();
                        // Filter to actual speakers
                        if (speaker.includes('Term') || speaker.includes('Policy') || speaker.length > 80) {
                            continue;
                        }
                        // Only keep if it looks like a character name
                        if (speaker.includes('Riv') || speaker.includes('Castiel') || speaker.includes('üíú') || 
                            speaker.includes("'") || speaker.includes('[')) {
                            speakerPositions.push({
                                speaker: speaker,
                                start: match.index + match[0].length,
                                matchStart: match.index
                            });
                        }
                    }
                    
                    console.log(`Found ${speakerPositions.length} speaker positions`);
                    
                    if (speakerPositions.length === 0) {
                        alert('Error: No speaker positions found. The MHTML format may not be supported.');
                        return;
                    }
                    
                    // Extract content between each speaker
                    const messageBlocks = [];
                    for (let i = 0; i < speakerPositions.length; i++) {
                        const current = speakerPositions[i];
                        
                        // Get content from this speaker to next speaker
                        let contentChunk;
                        if (i + 1 < speakerPositions.length) {
                            const nextPos = speakerPositions[i + 1].matchStart;
                            contentChunk = content.substring(current.start, nextPos);
                        } else {
                            contentChunk = content.substring(current.start, current.start + 10000);
                        }
                        
                        // Extract ALL <p> tags from this chunk
                        const paragraphPattern = /<p class="mb-1 break-words"[^>]*>(.*?)<\/p>/gs;
                        const paragraphs = [...contentChunk.matchAll(paragraphPattern)];
                        
                        if (paragraphs.length > 0) {
                            const texts = paragraphs.map(p => {
                                let text = p[1];
                                text = text.replace(/<[^>]+>/g, '');
                                text = decodeHTML(text);
                                return text.trim();
                            }).filter(t => t.length > 0);
                            
                            if (texts.length > 0) {
                                // Determine speaker type
                                let isAssistant = false;
                                let isUser = false;
                                
                                if (assistantName && current.speaker.toLowerCase().includes(assistantName.toLowerCase())) {
                                    isAssistant = true;
                                } else if (userName && current.speaker.toLowerCase().includes(userName.toLowerCase())) {
                                    isUser = true;
                                } else {
                                    // Auto-detect: purple heart = assistant
                                    isAssistant = current.speaker.includes('üíú');
                                    isUser = !isAssistant;
                                }
                                
                                messageBlocks.push({
                                    speaker: isAssistant ? 'assistant' : 'user',
                                    text: texts.join('\n\n'),
                                    originalSpeaker: current.speaker,
                                    paragraphCount: texts.length
                                });
                            }
                        }
                    }
                    
                    console.log(`Extracted ${messageBlocks.length} message blocks`);
                    
                    if (messageBlocks.length === 0) {
                        alert('Error: No message blocks could be extracted from the file.');
                        return;
                    }
                    
                    // Auto-detect message order
                    let swapOrder = document.getElementById('swapOrder').checked;
                    
                    // If not manually set, auto-detect
                    if (!swapOrder && messageBlocks.length >= 2) {
                        if (messageBlocks[0].speaker === 'assistant' && messageBlocks[1].speaker === 'user') {
                            console.log('Auto-detected: Chat starts with Assistant, auto-enabling swap');
                            swapOrder = true;
                        }
                    }
                    
                    console.log(`Using swap order: ${swapOrder}`);
                    
                    const turns = [];
                    
                    for (let i = 0; i < messageBlocks.length; i++) {
                        const current = messageBlocks[i];
                        const next = messageBlocks[i + 1];
                        
                        if (!next) {
                            console.log(`Reached end at block ${i}`);
                            break;
                        }
                        
                        let userMsg, assistantMsg;
                        
                        if (!swapOrder) {
                            if (current.speaker === 'user' && next.speaker === 'assistant') {
                                userMsg = current.text;
                                assistantMsg = next.text;
                                console.log(`Turn ${turns.length}: user‚Üíassistant`);
                                i++;
                            } else {
                                console.log(`Skip ${i}: ${current.speaker}‚Üí${next.speaker} (expected user‚Üíassistant)`);
                                continue;
                            }
                        } else {
                            if (current.speaker === 'assistant' && next.speaker === 'user') {
                                assistantMsg = current.text;
                                userMsg = next.text;
                                console.log(`Turn ${turns.length}: assistant‚Üíuser`);
                                i++;
                            } else {
                                console.log(`Skip ${i}: ${current.speaker}‚Üí${next.speaker} (expected assistant‚Üíuser)`);
                                continue;
                            }
                        }
                        
                        turns.push({
                            conversation_id: '',
                            creation_timestamp: turns.length,
                            user_id: '',
                            user_prompt: userMsg,
                            model_responses: [assistantMsg],
                            model_thoughts: [],
                            update_timestamp: String(turns.length),
                            attachments: []
                        });
                    }
                    
                    console.log(`Created ${turns.length} turns`);
                    
                    if (turns.length === 0) {
                        alert('No conversation turns could be created. Check console (F12) for details.');
                        return;
                    }
                    
                    // Create conversation object
                    const conversation = {
                        conversation: {
                            title: title,
                            creation_timestamp: Math.floor(Date.now() / 1000),
                            update_timestamp: Math.floor(Date.now() / 1000),
                            token_count: 'N/A'
                        },
                        turns: turns
                    };
                    
                    console.log('Creating JSON...');
                    
                    // Download JSON
                    const jsonStr = JSON.stringify(conversation, null, 2);
                    const blob = new Blob([jsonStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = title.replace(/[^a-z0-9]/gi, '_').toLowerCase() + '.json';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    URL.revokeObjectURL(url);
                    
                    console.log('Download triggered');
                    
                    // Success message
                    document.getElementById('uploadSection').innerHTML = `
                        <div class="upload-icon">‚úÖ</div>
                        <h3>Conversion Complete!</h3>
                        <p style="color: #48bb78; margin: 1rem 0;">
                            Successfully converted ${turns.length} conversation turns
                        </p>
                        <p style="color: #718096; margin-bottom: 1rem;">
                            Title: ${title}
                        </p>
                        <button class="btn" onclick="location.reload()">Convert Another</button>
                    `;
                    
                } catch (error) {
                    console.error('Error during processing:', error);
                    alert('Error during conversion: ' + error.message + '\n\nCheck console (F12) for details.');
                }
            };
            
            reader.onerror = function(error) {
                console.error('Error reading file:', error);
                alert('Error reading file: ' + error);
            };
            
            reader.readAsText(file);
        }
    </script>
</body>
</html>
